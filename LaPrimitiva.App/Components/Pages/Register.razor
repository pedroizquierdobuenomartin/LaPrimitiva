@using LaPrimitiva.Domain.Repositories
@using LaPrimitiva.Domain.Localization
@using LaPrimitiva.Domain.Entities
@using LaPrimitiva.Application.Interfaces
@using LaPrimitiva.Application.Services
@using Microsoft.Extensions.Localization
@inject IPlanRepository PlanRepository
@inject IDrawRepository DrawRepository
@inject GlobalState GlobalState
@inject IDrawService DrawService
@inject IStringLocalizer<PrimitivaResource> L
@implements IDisposable
@page "/register"

<PageTitle>Registro - La Primitiva Audit</PageTitle>

<div class="space-y-6">
    <div class="flex justify-between items-end">
        <div>
            <h2 class="text-3xl font-extrabold text-slate-900 text-transparent bg-clip-text bg-gradient-to-r from-slate-900 to-slate-500">@L["Registration"]</h2>
            <p class="text-slate-500">@L["DrawRecordsForYear"] @GlobalState.SelectedYear.</p>
        </div>
        <div class="flex gap-4 items-end">
            <button @onclick="ShowRegisterModal" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-2xl text-sm font-bold shadow-lg shadow-blue-200 transition-all flex items-center gap-2 transform hover:scale-105 active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                @L["AddNewDraw"]
            </button>
            <div class="bg-white/80 backdrop-blur-md px-4 py-3 rounded-2xl border border-slate-200 shadow-sm h-full flex items-center gap-3">
                <div class="h-2 w-2 rounded-full @(allPlans?.Any() == true ? "bg-emerald-500 animate-pulse" : "bg-rose-500")"></div>
                <span class="text-slate-500 text-xs font-bold uppercase tracking-wider">@L["Plan"]:</span>
                @if (allPlans?.Any() == true)
                {
                    <select @bind="SelectedPlanId" class="text-slate-900 text-sm font-bold bg-transparent border-none p-0 focus:ring-0 cursor-pointer">
                        @foreach (var plan in allPlans)
                        {
                            <option value="@plan.Id">@plan.Name</option>
                        }
                    </select>
                }
                else
                {
                    <span class="text-rose-600 text-sm font-bold">No existe plan</span>
                }
            </div>
        </div>
    </div>

    @if (drawsWithCumulative == null)
    {
        <div class="flex justify-center p-24">
            <div class="relative">
                <div class="h-24 w-24 rounded-full border-4 border-slate-100 border-t-blue-600 animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center text-blue-600 font-bold text-xs">Cargando</div>
            </div>
        </div>
    }
    else
    {
        <div class="bg-white rounded-3xl border border-slate-200 shadow-2xl shadow-slate-200/50 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-separate border-spacing-0 min-w-max">
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="sticky left-0 z-20 bg-slate-50/90 backdrop-blur-sm px-4 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest border-r border-slate-200">@L["Week"]</th>
                            <th class="sticky left-[72px] z-20 bg-slate-50/90 backdrop-blur-sm px-4 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest border-r border-slate-200">@L["DrawType"]</th>
                            <th class="sticky left-[142px] z-20 bg-slate-50/90 backdrop-blur-sm px-4 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest border-r border-slate-200">@L["Date"]</th>
                            <th class="px-3 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest text-center">J.</th>
                            
                            <!-- Detailed Audit Headers -->
                            <th class="px-3 py-4 text-[10px] font-black text-slate-500 uppercase tracking-widest text-right bg-slate-100/30">C. Fija</th>
                            <th class="px-3 py-4 text-[10px] font-black text-slate-500 uppercase tracking-widest text-right bg-slate-100/30">C. Auto</th>
                            <th class="px-4 py-4 text-[10px] font-black text-slate-900 uppercase tracking-widest text-right bg-slate-100/50">Total C.</th>
                            
                            <th class="px-3 py-4 text-[10px] font-black text-blue-600/70 uppercase tracking-widest text-right bg-blue-50/30">P. Fija</th>
                            <th class="px-3 py-4 text-[10px] font-black text-blue-600/70 uppercase tracking-widest text-right bg-blue-50/30">P. Auto</th>
                            <th class="px-4 py-4 text-[10px] font-black text-blue-900 uppercase tracking-widest text-right bg-blue-100/30">Total P.</th>
                            
                            <th class="px-4 py-4 text-[10px] font-black text-slate-900 uppercase tracking-widest text-right border-l border-slate-200">@L["Net"]</th>
                            <th class="px-4 py-4 text-[10px] font-black text-white uppercase tracking-widest text-right bg-slate-900">@L["Acumulado"]</th>
                            <th class="px-4 py-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">@L["Notes"]</th>
                            <th class="px-4 py-4"></th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 font-mono text-[11px]">
                        @foreach (var item in drawsWithCumulative)
                        {
                            var draw = item.Draw;
                            <tr class="hover:bg-blue-50/30 transition-colors group">
                                <td class="sticky left-0 z-10 bg-white group-hover:bg-blue-50/30 px-4 py-3 font-bold text-slate-500 border-r border-slate-100 text-center">@draw.WeekNumber</td>
                                <td class="sticky left-[72px] z-10 bg-white group-hover:bg-blue-50/30 px-4 py-3 border-r border-slate-100 italic">@draw.DrawType</td>
                                <td class="sticky left-[142px] z-10 bg-white group-hover:bg-blue-50/30 px-4 py-3 border-r border-slate-100">@draw.DrawDate.ToString("dd/MM/yy")</td>
                                <td class="px-3 py-3 text-center">
                                    <div class="flex justify-center">
                                        <div class="h-4 w-4 rounded-full @(draw.Played ? "bg-blue-500" : "bg-slate-200") flex items-center justify-center text-[8px] text-white">
                                            @(draw.Played ? "✓" : "")
                                        </div>
                                    </div>
                                </td>
                                
                                <td class="px-3 py-3 text-right text-slate-400">@draw.CosteFija.ToString("N2")€</td>
                                <td class="px-3 py-3 text-right text-slate-400">@draw.CosteAuto.ToString("N2")€</td>
                                <td class="px-4 py-3 text-right font-bold text-slate-700 bg-slate-50/30">@draw.TotalCoste.ToString("N2")€</td>

                                <td class="px-3 py-3 text-right text-blue-500">@draw.FixedPrize.ToString("N2")€</td>
                                <td class="px-3 py-3 text-right text-blue-500">@draw.AutoPrize.ToString("N2")€</td>
                                <td class="px-4 py-3 text-right font-bold text-blue-700 bg-blue-50/20">@draw.TotalPremios.ToString("N2")€</td>

                                <td class="px-4 py-3 text-right font-bold border-l border-slate-100 @(draw.Neto >= 0 ? "text-emerald-600" : "text-rose-600")">
                                    @draw.Neto.ToString("N2")€
                                </td>
                                <td class="px-4 py-3 text-right font-black bg-slate-900/5 @(draw.Acumulado >= 0 ? "text-emerald-700" : "text-rose-700")">
                                    @draw.Acumulado.ToString("N2")€
                                </td>
                                
                                <td class="px-4 py-3 max-w-[150px] truncate text-slate-400 italic">@draw.Notes</td>
                                
                                <td class="px-4 py-3 flex items-center justify-end gap-2">
                                    <button @onclick="() => EditDraw(draw)" class="p-1.5 rounded-lg text-slate-300 hover:text-blue-600 hover:bg-blue-50 transition-all" title="Editar Semana">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                    </button>
                                    <button @onclick="() => ConfirmDeleteWeek(draw.WeekNumber, draw.DrawDate.Year, draw.PlanId)" class="p-1.5 rounded-lg text-slate-300 hover:text-rose-600 hover:bg-rose-50 transition-all" title="Eliminar Semana">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

<!-- Modal Refined to match requirement list -->
@if (showModal)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/70 backdrop-blur-md transition-all">
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-6xl max-h-[92vh] overflow-hidden flex flex-col animate-in fade-in zoom-in duration-300">
            <!-- Modal Header -->
            <div class="px-10 py-8 border-b border-slate-100 flex justify-between items-center bg-white">
                <div class="flex items-center gap-6">
                    <div class="h-14 w-14 rounded-2xl @(isNewRegistration ? "bg-blue-600 shadow-blue-200" : "bg-indigo-600 shadow-indigo-200") flex items-center justify-center text-white shadow-xl">
                        @if (isNewRegistration)
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                            </svg>
                        }
                        else
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                            </svg>
                        }
                    </div>
                    <div>
                        <h3 class="text-2xl font-black text-slate-900">@(isNewRegistration ? L["AddNewWeeklyDrawTitle"] : L["EditWeeklyDrawTitle"])</h3>
                        <p class="text-slate-400 font-medium">@(isNewRegistration ? L["WeeklyDrawAuditSubtitle"] : L["WeeklyDrawEditSubtitle"])</p>
                    </div>
                </div>
                <button @onclick="CloseModal" class="h-12 w-12 hover:bg-slate-100 rounded-2xl flex items-center justify-center transition-all text-slate-300 hover:text-slate-900">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="flex-1 overflow-auto p-10 bg-slate-50/50">
                <!-- Week & Plan Info -->
                <div class="flex flex-wrap gap-8 mb-10">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex-1 min-w-[200px]">
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">@L["WeekNumberLabel"]</label>
                        <div class="flex items-center gap-4">
                            <input type="number" @bind="modalWeek" class="w-24 text-3xl font-black text-blue-600 bg-transparent border-none p-0 focus:ring-0" />
                            <button @onclick="LoadWeekDataInModal" class="text-xs font-bold text-blue-600 hover:text-blue-700 flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                @L["LoadDataButton"]
                            </button>
                        </div>
                    </div>
                    <div class="bg-blue-600 p-6 rounded-3xl shadow-xl shadow-blue-200 flex-[2] min-w-[300px] text-white overflow-hidden relative">
                        <div class="relative z-10">
                            <label class="block text-[10px] font-black text-blue-200 uppercase tracking-widest mb-2">@L["ActivePlanDetected"]</label>
                            <div class="text-2xl font-black">@activePlanName</div>
                            <div class="mt-2 text-[10px] font-bold text-blue-100">
                                @(modalPlan?.BetsPerDraw ?? 0) @L["BetsPerDraw"] • Joker @(modalPlan?.EnableJoker == true ? L["Yes"] : L["No"])
                            </div>
                        </div>
                        <svg class="absolute -right-4 -bottom-4 h-32 w-32 text-blue-500 opacity-20" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/></svg>
                    </div>
                </div>

                @if (isModalLoading)
                {
                    <div class="flex justify-center p-20">
                        <div class="h-12 w-12 rounded-full border-4 border-slate-100 border-t-blue-600 animate-spin"></div>
                    </div>
                }
                else if (isNewRegistration && modalDraws == null)
                {
                    <div class="bg-white rounded-[3rem] border border-slate-100 shadow-sm p-12">
                        <div class="max-w-4xl mx-auto space-y-10">
                            <div class="text-center">
                                <h4 class="text-2xl font-black text-slate-900 uppercase tracking-tighter">Configuración de la Semana</h4>
                                <p class="text-slate-400 font-medium mt-1">Selecciona el plan y los sorteos que se han jugado en la semana @modalWeek.</p>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                                <!-- Plan Selection -->
                                <div class="space-y-4">
                                    <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">@L["SelectPlanLabel"]</label>
                                    <select @bind="selectedPlanId" class="w-full bg-slate-50 border-none rounded-2xl p-4 text-sm font-bold text-slate-700 focus:ring-2 focus:ring-blue-500/20">
                                        @if (allPlans != null)
                                        {
                                            @foreach (var plan in allPlans)
                                            {
                                                <option value="@plan.Id">@plan.Name (@plan.BetsPerDraw Apuestas)</option>
                                            }
                                        }
                                    </select>
                                </div>

                                <!-- Custom Draw Addition -->
                                <div class="space-y-4">
                                    <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">Añadir Sorteos Individuales</label>
                                    <div class="flex flex-wrap gap-2">
                                        <button @onclick='() => AddDrawTemplate(DayOfWeek.Monday)' class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-xs font-black uppercase hover:bg-blue-100 transition-colors">+ Lunes</button>
                                        <button @onclick='() => AddDrawTemplate(DayOfWeek.Thursday)' class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-xs font-black uppercase hover:bg-blue-100 transition-colors">+ Jueves</button>
                                        <button @onclick='() => AddDrawTemplate(DayOfWeek.Saturday)' class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-xs font-black uppercase hover:bg-blue-100 transition-colors">+ Sábado</button>
                                    </div>
                                    
                                    @if (tempModalDraws.Any())
                                    {
                                        <div class="mt-4 space-y-2">
                                            @foreach (var d in tempModalDraws)
                                            {
                                                <div class="bg-white border border-slate-100 p-3 rounded-xl flex justify-between items-center shadow-sm">
                                                    <div>
                                                        <span class="text-xs font-black text-slate-900">@d.DrawType</span>
                                                        <span class="text-[10px] text-slate-400 ml-2">@d.DrawDate.ToString("dd/MM/yyyy")</span>
                                                    </div>
                                                    <button @onclick="() => tempModalDraws.Remove(d)" class="text-rose-500 hover:bg-rose-50 p-1.5 rounded-lg transition-colors">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                        </svg>
                                                    </button>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>

                            @if (!string.IsNullOrEmpty(modalErrorMessage))
                            {
                                <div class="p-4 bg-rose-50 border border-rose-100 rounded-2xl flex gap-3 items-center animate-in slide-in-from-top-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-rose-500 shrink-0" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                    <p class="text-xs font-bold text-rose-700">@modalErrorMessage</p>
                                </div>
                            }

                            <div class="pt-6 flex justify-center">
                                <button @onclick="PrepareNewWeek" disabled="@(!tempModalDraws.Any())" class="bg-blue-600 text-white px-10 py-4 rounded-2xl font-black uppercase tracking-widest shadow-xl shadow-blue-200 hover:bg-blue-700 transition-all flex items-center gap-3 disabled:opacity-30">
                                    @L["CreateAuditedTemplateButton"]
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                }
                else if (modalDraws != null && modalDraws.Any())
                {
                    <div class="space-y-6">
                        @foreach (var draw in modalDraws.OrderBy(d => d.DrawDate))
                        {
                            <div class="bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden p-8 flex flex-col lg:flex-row gap-8 items-start lg:items-center">
                                <!-- Draw Identity -->
                                <div class="w-full lg:w-48 space-y-2">
                                    <div class="text-xs font-black text-slate-400 uppercase tracking-widest">@L["DrawType"]</div>
                                    <div class="text-2xl font-black text-slate-900">@draw.DrawType</div>
                                    <div class="text-sm font-bold text-slate-500 font-mono">@draw.DrawDate.ToString("dd/MM/yyyy")</div>
                                    <label class="flex items-center gap-3 mt-4 p-3 rounded-2xl cursor-pointer transition-all @(draw.Played ? "bg-blue-50 text-blue-600" : "bg-slate-50 text-slate-400 hover:bg-slate-100")">
                                        <input type="checkbox" @bind="draw.Played" @bind:after="() => RecalculateDraw(draw, forceDefaults: true)" class="h-5 w-5 rounded-lg border-current focus:ring-0" />
                                        <span class="text-sm font-black uppercase tracking-wider">@L["PlayedLabel"]</span>
                                    </label>
                                </div>

                                <!-- Forms -->
                                <div class="flex-1 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    <!-- Costs Summary -->
                                    <div class="space-y-4">
                                        <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">@L["AuditedCostsTitle"]</div>
                                        <div class="space-y-3">
                                            <div class="group">
                                                <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">@L["FixedCostLabel"]</label>
                                                <input type="number" step="0.01" @bind="draw.CosteFija" @bind:after="() => RecalculateDraw(draw)" disabled="@(!draw.Played)" class="w-full bg-slate-50 border-none rounded-xl p-3 text-sm font-bold focus:ring-2 focus:ring-blue-500/20 disabled:opacity-50 disabled:cursor-not-allowed" />
                                            </div>
                                            <div class="group">
                                                <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">@L["AutoCostLabel"]</label>
                                                <input type="number" step="0.01" @bind="draw.CosteAuto" @bind:after="() => RecalculateDraw(draw)" disabled="@(!draw.Played)" class="w-full bg-slate-50 border-none rounded-xl p-3 text-sm font-bold focus:ring-2 focus:ring-blue-500/20 disabled:opacity-50 disabled:cursor-not-allowed" />
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Prizes Entry -->
                                    <div class="space-y-4">
                                        <div class="text-[10px] font-black text-blue-400 uppercase tracking-widest px-1">Premios Registrados</div>
                                        <div class="space-y-3">
                                            <div class="group">
                                                <label class="text-[9px] font-bold text-blue-400 uppercase ml-1">Premio Fija (€)</label>
                                                <input type="number" step="0.01" @bind="draw.FixedPrize" @bind:after="() => RecalculateDraw(draw)" disabled="@(!draw.Played || draw.CosteFija == 0)" class="w-full bg-blue-50/50 border-none rounded-xl p-3 text-sm font-bold text-blue-700 focus:ring-2 focus:ring-blue-500/20 disabled:opacity-50 disabled:cursor-not-allowed" />
                                            </div>
                                            <div class="group">
                                                <label class="text-[9px] font-bold text-blue-400 uppercase ml-1">Premio Auto (€)</label>
                                                <input type="number" step="0.01" @bind="draw.AutoPrize" @bind:after="() => RecalculateDraw(draw)" disabled="@(!draw.Played || draw.CosteAuto == 0)" class="w-full bg-blue-50/50 border-none rounded-xl p-3 text-sm font-bold text-blue-700 focus:ring-2 focus:ring-blue-500/20 disabled:opacity-50 disabled:cursor-not-allowed" />
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Results (Computed persistence) -->
                                    <div class="space-y-4 md:col-span-2 lg:col-span-1">
                                        <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">@L["FinalResultsTitle"]</div>
                                        <div class="bg-slate-50/80 rounded-2xl p-4 space-y-4">
                                            <div class="flex justify-between items-center text-[10px] font-bold">
                                                <span class="text-slate-400">@L["TotalCostLabel"]:</span>
                                                <span class="text-slate-900">@draw.TotalCoste.ToString("N2")€</span>
                                            </div>
                                            <div class="flex justify-between items-center text-[10px] font-bold">
                                                <span class="text-blue-500">@L["TotalPrizesLabel"]:</span>
                                                <span class="text-blue-700">@draw.TotalPremios.ToString("N2")€</span>
                                            </div>
                                            <div class="pt-2 border-t border-slate-200 flex justify-between items-center">
                                                <span class="text-[10px] font-black text-slate-500">@L["NetDrawLabel"]:</span>
                                                <span class="text-lg font-black @(draw.Neto >= 0 ? "text-emerald-600" : "text-rose-600")">@draw.Neto.ToString("N2")€</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Notes -->
                                    <div class="space-y-4">
                                        <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-1 text-right">Observaciones</div>
                                        <textarea @bind="draw.Notes" class="w-full bg-slate-50 border-none rounded-2xl p-4 text-[11px] font-medium text-slate-600 focus:ring-2 focus:ring-blue-500/20 h-28 resize-none" placeholder="Añade notas de auditoría aquí..."></textarea>
                                    </div>
                                </div>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(modalErrorMessage))
                        {
                            <div class="p-4 bg-rose-50 border border-rose-100 rounded-2xl flex gap-3 items-center animate-in slide-in-from-top-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-rose-500 shrink-0" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                                <p class="text-xs font-bold text-rose-700">@modalErrorMessage</p>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-20 bg-slate-100/50 rounded-[3rem] border-4 border-dashed border-slate-100 flex flex-col items-center">
                        <div class="h-24 w-24 rounded-full bg-white flex items-center justify-center text-slate-200 mb-6 shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                            </svg>
                        </div>
                        <p class="text-lg font-black text-slate-300 uppercase tracking-widest">@L["EnterWeekNumberPrompt"]</p>
                        <p class="text-slate-400 mt-2 font-medium">@L["ClickLoadDataPrompt"]</p>
                    </div>
                }
            </div>

            <!-- Modal Footer -->
            <div class="px-10 py-8 border-t border-slate-100 bg-white flex justify-end gap-5">
                <button @onclick="CloseModal" class="px-8 py-4 rounded-2xl text-sm font-black text-slate-500 hover:bg-slate-100 transition-all uppercase tracking-widest">
                    @L["CancelButton"]
                </button>
                @if (!isNewRegistration && modalDraws != null && modalDraws.Any())
                {
                    <button @onclick="() => ConfirmDeleteWeek(modalWeek, GlobalState.SelectedYear, modalPlan?.Id ?? Guid.Empty)" class="px-8 py-4 rounded-2xl text-sm font-black text-rose-500 hover:bg-rose-50 hover:text-rose-600 transition-all uppercase tracking-widest flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        @L["DeleteButton"]
                    </button>
                }
                <button @onclick="SaveModalChanges" disabled="@(modalDraws == null || !modalDraws.Any())" class="px-12 py-4 rounded-[1.5rem] text-sm font-black bg-slate-900 text-white hover:bg-black shadow-2xl shadow-slate-200 transition-all disabled:opacity-30 uppercase tracking-widest">
                    @L["SaveAuditedWeekButton"]
                </button>
            </div>
        </div>
    </div>
}

<!-- Confirmation Modal -->
@if (showDeleteArgs != null)
{
    <div class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm transition-all animate-in fade-in duration-200">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-in zoom-in duration-200 p-8 text-center space-y-6">
            <div class="h-20 w-20 bg-rose-100 rounded-full flex items-center justify-center mx-auto text-rose-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            
            <div>
                <h3 class="text-xl font-black text-slate-900">@L["DeleteWeekConfirmTitle"] @showDeleteArgs.Value.WeekNumber?</h3>
                <p class="text-slate-500 mt-2 text-sm leading-relaxed">
                    @L["DeleteWeekWarningText"] <strong>@L["Week"] @showDeleteArgs.Value.WeekNumber</strong> @L["Date"] @showDeleteArgs.Value.Year.
                    <br/><br/>
                    <span class="text-rose-600 font-bold">@L["NoUndoWarning"]</span>
                </p>
            </div>

            <div class="grid grid-cols-2 gap-4 pt-2">
                <button @onclick="CancelDelete" class="px-4 py-3 rounded-xl text-sm font-bold text-slate-500 bg-slate-100 hover:bg-slate-200 transition-colors">
                    @L["CancelButton"]
                </button>
                <button @onclick="ExecuteDelete" class="px-4 py-3 rounded-xl text-sm font-bold text-white bg-rose-600 hover:bg-rose-700 shadow-lg shadow-rose-200 transition-transform active:scale-95">
                    @L["ConfirmDeleteButton"]
                </button>
            </div>
        </div>
    </div>
}

@code {
    private List<DrawWithCumulative>? drawsWithCumulative;
    private string activePlanName = "Sin Plan";
    private Plan? modalPlan;

    // Modal State
    private bool showModal = false;
    private int modalWeek = 0;
    private List<DrawRecord>? modalDraws;
    private bool isModalLoading = false;
    private bool isNewRegistration = false;
    private List<Plan>? allPlans;
    private Guid? selectedPlanId;
    private List<DrawRecord> tempModalDraws = new();
    private string? modalErrorMessage;
    private bool _isLoading;
    
    // Delete Confirmation State
    private (int WeekNumber, int Year, Guid PlanId)? showDeleteArgs;

    private class DrawWithCumulative
    {
        public DrawRecord Draw { get; set; } = null!;
        // Note: Field mapping is now direct to Entity Properties (Neto, Acumulado)
    }

    protected override async Task OnInitializedAsync()
    {
        GlobalState.OnChange += HandleStateChange;
        
        // Try to identify current week if possible
        modalWeek = GetCurrentWeekNumber();
        
        await LoadData();
    }

    private int GetCurrentWeekNumber()
    {
        var year = GlobalState.SelectedYear;
        var now = DateTime.Now;
        var referenceDate = now.Year == year ? now : new DateTime(year, 1, 1);
        
        var start = new DateTime(year, 1, 1);
        while (start.DayOfWeek != DayOfWeek.Monday) start = start.AddDays(1);
        
        if (referenceDate < start) return 1;
        return ((referenceDate - start).Days / 7) + 1;
    }

    private async void HandleStateChange()
    {
        await InvokeAsync(async () => 
        {
            try 
            {
                await LoadData();
            }
            finally 
            {
                StateHasChanged();
            }
        });
    }

    private async Task LoadData()
    {
        if (_isLoading) return;
        _isLoading = true;

        try
        {
            var year = GlobalState.SelectedYear;
            
            // Ensure allPlans is loaded for the year
            var planDtos = await PlanRepository.GetByYearAsync(year);
            allPlans = planDtos.Select(p => new Plan 
            {
                Id = p.Id,
                Name = p.Name,
                BetsPerDraw = p.BetsPerDraw,
                EnableJoker = p.EnableJoker,
                EffectiveFrom = p.EffectiveFrom
            }).ToList();

            if (allPlans.Any())
            {
                // If no plan selected OR selected plan doesn't belong to current year's plans
                if (GlobalState.SelectedPlanId == null || !allPlans.Any(p => p.Id == GlobalState.SelectedPlanId))
                {
                    GlobalState.SelectedPlanId = allPlans.OrderByDescending(p => p.EffectiveFrom).First().Id;
                }
            }
            else
            {
                GlobalState.SelectedPlanId = null;
            }

            var query = await DrawRepository.GetListAsync(d => d.DrawDate.Year == year);
            
            if (GlobalState.SelectedPlanId != null)
            {
                query = query.Where(d => d.PlanId == GlobalState.SelectedPlanId).ToList();
            }

            var rawDraws = query;

            // Recalculate Acumulado if missing or mismatch (ensure view consistency)
            decimal runningNet = 0;
            foreach (var d in rawDraws)
            {
                runningNet += d.Neto;
                d.Acumulado = runningNet;
            }

            drawsWithCumulative = rawDraws.Select(d => new DrawWithCumulative { Draw = d }).Reverse().ToList();

            if (rawDraws.Any())
            {
                var lastDraw = rawDraws.Last();
                activePlanName = allPlans?.FirstOrDefault(p => p.Id == lastDraw.PlanId)?.Name ?? "Sin Plan";
            }
            else
            {
                activePlanName = allPlans?.FirstOrDefault(p => p.Id == GlobalState.SelectedPlanId)?.Name ?? "Sin Plan";
            }
            
            StateHasChanged();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private Guid? SelectedPlanId
    {
        get => GlobalState.SelectedPlanId;
        set
        {
            if (GlobalState.SelectedPlanId != value)
            {
                GlobalState.SelectedPlanId = value;
                // Navigation/State change will trigger LoadData
            }
        }
    }

    private async Task SaveDraw(DrawRecord draw)
    {
        RecalculateDraw(draw);
        draw.UpdatedAt = DateTime.UtcNow;
        // In a real repo, we'd have Update, but for now we use SaveChanges if tracked 
        // OR we add an UpdateAsync to IDrawRepository.
        await DrawRepository.SaveChangesAsync();
        await LoadData();
        StateHasChanged();
    }

    private void RecalculateDraw(DrawRecord draw, bool forceDefaults = false)
    {
        if (forceDefaults)
        {
            // Snapshot audit fields - only if Plan is available
            if (draw.Plan != null)
            {
                draw.CosteFija = draw.Played ? draw.Plan.CostPerBet : 0;
                draw.CosteAuto = draw.Played ? draw.Plan.CostPerBet : 0;
                draw.CosteJokerFija = (draw.Played && draw.Plan.EnableJoker) ? draw.Plan.JokerCostPerBet : 0;
                draw.CosteJokerAuto = (draw.Played && draw.Plan.EnableJoker) ? draw.Plan.JokerCostPerBet : 0;
            }
        }

        if (!draw.Played)
        {
            draw.FixedPrize = 0;
            draw.AutoPrize = 0;
            draw.JokerFixedPrize = 0;
            draw.JokerAutoPrize = 0;
        }
        
        // The user wants TotalCoste to be exactly what's visible (Fija + Auto)
        draw.TotalCoste = draw.CosteFija + draw.CosteAuto;
        draw.TotalPremios = draw.FixedPrize + draw.AutoPrize;
        draw.Neto = draw.TotalPremios - draw.TotalCoste;
    }

    private void ShowRegisterModal()
    {
        isNewRegistration = true;
        modalWeek = GetCurrentWeekNumber();
        modalDraws = null;
        selectedPlanId = allPlans?.FirstOrDefault()?.Id;
        tempModalDraws.Clear();
        modalErrorMessage = null;
        showModal = true;
    }

    private async Task EditDraw(DrawRecord draw)
    {
        isNewRegistration = false;
        modalWeek = draw.WeekNumber;
        modalErrorMessage = null;
        showModal = true;
        await LoadWeekDataInModal();
    }

    private async Task LoadWeekDataInModal()
    {
        if (modalWeek <= 0) return;
        
        modalErrorMessage = null;
        isModalLoading = true;
        StateHasChanged();

        var year = GlobalState.SelectedYear;
        var existing = await DrawRepository.GetListAsync(d => 
            d.DrawDate.Year == year && d.WeekNumber == modalWeek);

        if (existing.Any())
        {
            isNewRegistration = false; // Forced to edit if exists
            modalDraws = existing;
            // Since we use AsNoTracking in repo, we might need a way to get Plan or include it.
            // I'll update IPlanRepository to help.
            if (modalDraws.Any())
            {
                var plan = await PlanRepository.GetAsync(modalDraws.First().PlanId);
                modalPlan = plan;
            }

            foreach (var d in modalDraws)
            {
                if (d.Played && d.TotalCoste == 0) 
                {
                    RecalculateDraw(d);
                }
            }
        }
        else if (!isNewRegistration)
        {
            modalDraws = null;
        }

        isModalLoading = false;
        StateHasChanged();
    }

    private void PrepareNewWeek()
    {
        if (!tempModalDraws.Any()) return;
        
        modalDraws = new List<DrawRecord>(tempModalDraws);
        // tempModalDraws are already configured with plan and dates
    }

    private void AddDrawTemplate(DayOfWeek day)
    {
        if (selectedPlanId == null || allPlans == null) return;
        var plan = allPlans.FirstOrDefault(p => p.Id == selectedPlanId);
        if (plan == null) return;

        var year = GlobalState.SelectedYear;
        var date = GetDateForWeekAndDay(year, modalWeek, day);
        
        if (tempModalDraws.Any(d => d.DrawDate.Date == date.Date))
        {
            modalErrorMessage = $"Ya has añadido un sorteo para el {date:dd/MM/yyyy}.";
            return;
        }

        modalErrorMessage = null;
        var draw = new DrawRecord
        {
            Id = Guid.Empty, // Explicitly set to empty for new draws
            WeekNumber = modalWeek,
            DrawDate = date,
            DrawType = GetDrawType(date),
            PlanId = plan.Id,
            Plan = plan,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        };
        RecalculateDraw(draw);
        tempModalDraws.Add(draw);
    }

    private DateTime GetDateForWeekAndDay(int year, int week, DayOfWeek day)
    {
        var startOfYear = new DateTime(year, 1, 1);
        var firstMonday = startOfYear;
        while (firstMonday.DayOfWeek != DayOfWeek.Monday) firstMonday = firstMonday.AddDays(1);
        
        var targetDate = firstMonday.AddDays((week - 1) * 7);
        // If the target day is earlier in the week than Monday (not possible in .NET as Monday=1), 
        // but let's be safe and adjust to the correct day of that week.
        while (targetDate.DayOfWeek != day) targetDate = targetDate.AddDays(1);
        
        return targetDate;
    }

    private DrawType GetDrawType(DateTime date)
    {
        return date.DayOfWeek switch
        {
            DayOfWeek.Monday => DrawType.Lunes,
            DayOfWeek.Thursday => DrawType.Jueves,
            DayOfWeek.Saturday => DrawType.Sabado,
            _ => (DrawType)1 // Default to Lunes if weird
        };
    }

    private void CloseModal()
    {
        showModal = false;
    }

    private async Task SaveModalChanges()
    {
        if (modalDraws == null) return;

        try 
        {
            modalErrorMessage = null;
            
            // Validate all draws before saving anything
            foreach (var draw in modalDraws)
            {
                await DrawService.ValidateDrawAsync(draw.PlanId, draw.DrawDate, draw.Id != Guid.Empty ? draw.Id : null);
            }

            // Separate new and existing
            var newDraws = new List<DrawRecord>();
            var existingDraws = new List<DrawRecord>();

            foreach (var draw in modalDraws)
            {
                RecalculateDraw(draw);
                draw.UpdatedAt = DateTime.UtcNow;
                
                // Decouple related Plan to avoid "Plan instance already tracked" error 
                var planRef = draw.Plan;
                draw.Plan = null!; 

                if (draw.Id == Guid.Empty)
                {
                    newDraws.Add(draw);
                }
                else
                {
                    existingDraws.Add(draw);
                }
            }

            // Batch insert new
            if (newDraws.Any())
            {
                await DrawRepository.CreateRangeAsync(newDraws);
            }

            // Batch update existing
            if (existingDraws.Any())
            {
                await DrawRepository.UpdateRangeAsync(existingDraws);
            }

            showModal = false;
            await LoadData();
            StateHasChanged();
        }
        catch (InvalidOperationException ex)
        {
            modalErrorMessage = ex.Message;
        }
        catch (Exception)
        {
            modalErrorMessage = "Ha ocurrido un error inesperado al guardar los cambios.";
        }
    }

    private void ConfirmDeleteWeek(int week, int year, Guid planId)
    {
        if (planId == Guid.Empty) return;
        showDeleteArgs = (week, year, planId);
    }

    private void CancelDelete()
    {
        showDeleteArgs = null;
    }

    private async Task ExecuteDelete()
    {
        if (showDeleteArgs == null) return;
        
        var args = showDeleteArgs.Value;
        await DrawService.DeleteWeeklyDrawAsync(args.WeekNumber, args.Year, args.PlanId);
        
        showDeleteArgs = null;
        showModal = false; // Close edit modal if open
        await LoadData();
        StateHasChanged();
    }

    public void Dispose()
    {
        GlobalState.OnChange -= HandleStateChange;
    }
}
